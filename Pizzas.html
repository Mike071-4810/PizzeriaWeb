<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzería Deliciosa - Pide por WhatsApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Color primario: #FF9800 (Naranja) */
        /* Color secundario: #FFC107 (Ámbar/Amarillo) */
        /* Color de acento/error: #F44336 (Rojo) */
        /* Color botones acción: green */

        .active-nav {
            border-bottom: 2px solid #FF9800; /* Naranja */
            color: #FF9800; /* Naranja */
        }
        .menu-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        #cart-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(-100%);
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: #10b981; } /* Verde (se mantiene para éxito) */
        .toast-error { background-color: #F44336; } /* Rojo #F44336 */

        /* Clases personalizadas para los nuevos colores */
        .bg-primary { background-color: #FF9800; }
        .text-primary { color: #FF9800; }
        .border-primary { border-color: #FF9800; }

        .bg-secondary { background-color: #FFC107; }
        .text-secondary { color: #FFC107; }
        
        .bg-accent-red { background-color: #F44336; }
        .text-accent-red { color: #F44336; }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Barra de Navegación -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-primary">Pizzería Deliciosa <i class="fas fa-pizza-slice"></i></a>
            <div class="hidden md:flex space-x-4">
                <a href="#menu" class="nav-link px-3 py-2 rounded hover:bg-secondary hover:text-gray-800 active-nav">Menú</a>
                <a href="#pedido" class="nav-link px-3 py-2 rounded hover:bg-secondary hover:text-gray-800">Hacer Pedido</a>
                <a href="#admin" class="nav-link px-3 py-2 rounded hover:bg-secondary hover:text-gray-800">Admin</a>
                <a href="#contacto" class="nav-link px-3 py-2 rounded hover:bg-secondary hover:text-gray-800">Contacto</a>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-700 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </nav>
        <!-- Menú móvil -->
        <div id="mobile-menu" class="md:hidden hidden bg-white shadow-lg">
            <a href="#menu" class="block px-4 py-2 text-sm text-gray-700 hover:bg-secondary hover:text-gray-800">Menú</a>
            <a href="#pedido" class="block px-4 py-2 text-sm text-gray-700 hover:bg-secondary hover:text-gray-800">Hacer Pedido</a>
            <a href="#admin" class="block px-4 py-2 text-sm text-gray-700 hover:bg-secondary hover:text-gray-800">Admin</a>
            <a href="#contacto" class="block px-4 py-2 text-sm text-gray-700 hover:bg-secondary hover:text-gray-800">Contacto</a>
        </div>
    </header>

    <!-- Botón flotante del carrito -->
    <button id="cart-fab" class="bg-primary text-white w-16 h-16 rounded-full shadow-lg hover:bg-orange-600 focus:outline-none flex items-center justify-center">
        <i class="fas fa-shopping-cart text-2xl"></i>
        <span id="cart-count-fab" class="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4 bg-accent-red text-xs font-bold text-white rounded-full h-6 w-6 flex items-center justify-center">0</span>
    </button>

    <!-- Sección Principal (Hero) -->
    <section id="hero" class="bg-primary text-white py-20">
        <div class="container mx-auto px-6 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">¡Las Mejores Pizzas de Holguín!</h1>
            <p class="text-lg md:text-xl mb-8">Hechas con amor y los ingredientes más frescos. Pide por WhatsApp.</p>
            <a href="#menu" class="bg-white text-primary font-bold py-3 px-8 rounded-full hover:bg-gray-200 transition duration-300">Ver Menú</a>
        </div>
    </section>

    <!-- Catálogo de Productos (Menú) -->
    <section id="menu" class="py-16">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Nuestro Menú <i class="fas fa-utensils text-primary"></i></h2>
            
            <h3 class="text-2xl font-semibold mb-6 text-gray-700">Pizzas Napolitanas</h3>
            <div id="napolitanas-pizzas" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                <!-- Las pizzas napolitanas se cargarán aquí por JS -->
            </div>

            <h3 class="text-2xl font-semibold mb-6 text-gray-700">Pizzas Familiares</h3>
            <div id="familiares-pizzas" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                <!-- Las pizzas familiares se cargarán aquí por JS -->
            </div>

            <h3 class="text-2xl font-semibold mb-6 text-gray-700">Bebidas</h3>
            <div id="bebidas-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-8 mb-12">
                <!-- Las bebidas se cargarán aquí por JS -->
            </div>

            <h3 class="text-2xl font-semibold mb-6 text-gray-700">Agregados</h3>
            <div id="agregados-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- Los agregados se cargarán aquí por JS -->
            </div>
        </div>
    </section>

    <!-- Carrito de Compras (Modal) -->
    <div id="cartModal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-3/5 lg:w-1/2 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">Tu Pedido <i class="fas fa-shopping-bag text-primary"></i></h3>
                <button id="closeCartModal" class="text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            </div>
            <div id="cart-items-container" class="flex-grow overflow-y-auto mb-4">
                <p id="empty-cart-message" class="text-gray-500">Tu carrito está vacío.</p>
            </div>
            <div class="border-t pt-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-semibold text-gray-800">Total:</span>
                    <span id="cart-total" class="text-xl font-bold text-primary">$0.00</span>
                </div>
                <button id="checkout-button" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition duration-300 disabled:opacity-50" disabled>
                    Revisar y Enviar Pedido
                </button>
            </div>
        </div>
    </div>
    
    <!-- Formulario de Pedido -->
    <section id="pedido" class="py-16 bg-gray-50 hidden">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Completa tus Datos para el Pedido <i class="fas fa-clipboard-list text-primary"></i></h2>
            <form id="order-form" class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow-md">
                <div class="mb-4">
                    <h4 class="text-xl font-semibold mb-2 text-gray-700">Detalles del Pedido:</h4>
                    <div id="order-summary" class="text-sm text-gray-700 p-3 bg-gray-100 rounded">
                        <!-- Resumen del pedido se cargará aquí -->
                    </div>
                    <p class="mt-2 text-gray-800"><strong>Total a Pagar: <span id="order-total-form" class="text-primary font-bold"></span></strong> (Pago contra entrega)</p>
                </div>
                <div class="mb-4">
                    <label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">Dirección de Entrega:</label>
                    <input type="text" id="direccion" name="direccion" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" required placeholder="Calle, Número, Reparto, etc.">
                </div>
                <div class="mb-4">
                    <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">Tu Número de Teléfono (para confirmación):</label>
                    <input type="tel" id="telefono" name="telefono" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" required placeholder="Ej: 5xxxxxxx">
                </div>
                <div class="mb-6">
                    <p class="text-sm text-gray-600"><strong>ID del Pedido:</strong> <span id="order-id-form" class="font-mono"></span></p>
                    <p class="text-sm text-gray-600"><strong>Tiempo Estimado de Entrega:</strong> <span id="estimated-time">35 minutos (aproximado)</span></p>
                </div>
                <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition duration-300 flex items-center justify-center">
                    <i class="fab fa-whatsapp mr-2"></i> Enviar Pedido por WhatsApp
                </button>
            </form>
        </div>
    </section>

    <!-- Panel de Administración (Simulado) -->
    <section id="admin" class="py-16 bg-gray-200 hidden">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Panel de Administración <i class="fas fa-user-shield text-primary"></i></h2>
            <div id="admin-login-section">
                <form id="admin-login-form" class="max-w-sm mx-auto bg-white p-8 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-center mb-4 text-gray-700">Acceso Administrador</h3>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700">Contraseña:</label>
                        <input type="password" id="admin-password" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="Contraseña admin">
                    </div>
                    <button type="submit" class="w-full mt-4 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Ingresar</button> <!-- Botón de admin puede ser azul -->
                </form>
            </div>

            <div id="admin-dashboard" class="hidden bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-semibold mb-6 text-gray-700">Listado de Pedidos (Enviados a WhatsApp)</h3>
                <div id="admin-orders-list" class="space-y-4 overflow-x-auto">
                     <p class="text-gray-600">No hay pedidos registrados en esta sesión.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Información del Local y Contacto -->
    <section id="contacto" class="py-16 bg-primary text-white">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold text-center mb-12">Visítanos o Contáctanos <i class="fas fa-map-marker-alt"></i></h2>
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div>
                    <h3 class="text-2xl font-semibold mb-4">Pizzería Deliciosa</h3>
                    <p class="mb-2"><i class="fas fa-map-pin mr-2"></i><strong>Dirección:</strong> Mercado Los Chinos, Holguín, Cuba</p>
                    <p class="mb-2"><i class="fas fa-clock mr-2"></i><strong>Horario de Atención:</strong> Lunes a Domingo, 7:00 AM - 4:00 PM</p>
                    <p class="mb-2"><i class="fab fa-whatsapp mr-2"></i><strong>Pedidos por WhatsApp:</strong> +53 6363 4465</p>
                    <p class="text-sm mt-4">¡Esperamos tu pedido!</p>
                </div>
                <div>
                    <h4 class="text-xl font-semibold mb-3">Ubicación (Holguín Centro):</h4>
                    <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-lg">
                        <iframe 
                            src="https://www.openstreetmap.org/export/embed.html?bbox=-76.2700%2C20.8800%2C-76.2500%2C20.8950&layer=mapnik&marker=20.8875%2C-76.2620" 
                            style="border:0; width:100%; height:100%;" 
                            allowfullscreen="" 
                            loading="lazy"
                            title="Mapa de Holguín">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 text-center">
        <p>&copy; <span id="current-year"></span> Pizzería Deliciosa. Todos los derechos reservados.</p>
        <p class="text-sm">Tu pizza favorita, a un WhatsApp de distancia.</p>
    </footer>

    <!-- Toast Message Container -->
    <div id="toast-container"></div>

<script>
    // --- Variables Globales y Estado de la Aplicación ---
    let cart = []; 
    let allOrders = []; 
    const ADMIN_PASSWORD = "admin123"; 
    const WHATSAPP_NUMBER = "5363634465"; 

    // --- Datos de Productos ---
    const products = {
        pizzasNapolitanas: [
            { id: 'pn1', name: 'Pizza Napolitana', price: 150, description: 'Clásica pizza napolitana individual.', image: 'images/pizza%20napolitana%20cubana.jpg' }
        ],
        pizzasFamiliares: [
            { id: 'pf1', name: 'Pizza Familiar', price: 3000, description: 'Pizza grande para compartir en familia.', image: 'images/pizzaFamiliar.jpg' }
        ],
        bebidas: [
            { id: 'b1', name: 'Refresco de Lata (Cola)', price: 240, description: 'Lata de refresco sabor cola.', image: 'https://placehold.co/300x200/F44336/FFFFFF?text=Refresco+Cola' },
            { id: 'b2', name: 'Refresco de Lata (Piña)', price: 240, description: 'Lata de refresco sabor piña.', image: 'https://placehold.co/300x200/FFEB3B/000000?text=Refresco+Piña' },
            { id: 'b3', name: 'Refresco de Lata (Limón)', price: 240, description: 'Lata de refresco sabor limón.', image: 'https://placehold.co/300x200/CDDC39/000000?text=Refresco+Limón' },
            { id: 'b4', name: 'Refresco de Lata (Naranja)', price: 240, description: 'Lata de refresco sabor naranja.', image: 'https://placehold.co/300x200/FF9800/000000?text=Refresco+Naranja' },
            { id: 'b5', name: 'Malta de Lata (Santa Isabel)', price: 260, description: 'Malta en lata marca Santa Isabel.', image: 'https://placehold.co/300x200/795548/FFFFFF?text=Malta+Santa+Isabel' },
            { id: 'b6', name: 'Malta Guajira', price: 300, description: 'Malta marca Guajira.', image: 'https://placehold.co/300x200/8D6E63/FFFFFF?text=Malta+Guajira' },
            { id: 'b7', name: 'Cerveza Parranda', price: 220, description: 'Cerveza nacional Parranda.', image: 'https://placehold.co/300x200/FFC107/000000?text=Cerveza+Parranda' },
            { id: 'b8', name: 'Cerveza Mayabe', price: 220, description: 'Cerveza nacional Mayabe.', image: 'https://placehold.co/300x200/FFD54F/000000?text=Cerveza+Mayabe' },
            { id: 'b9', name: 'Jugo Manzana', price: 200, description: 'Jugo de manzana.', image: 'https://placehold.co/300x200/F44336/FFFFFF?text=Jugo+Manzana' },
            { id: 'b10', name: 'Jugo Mango', price: 200, description: 'Jugo de mango.', image: 'https://placehold.co/300x200/FF9800/FFFFFF?text=Jugo+Mango' },
            { id: 'b11', name: 'Jugo Melocotón', price: 200, description: 'Jugo de melocotón.', image: 'https://placehold.co/300x200/FFB74D/000000?text=Jugo+Melocotón' },
            { id: 'b12', name: 'Pru Frío', price: 50, description: 'Bebida refrescante Pru.', image: 'https://placehold.co/300x200/4CAF50/FFFFFF?text=Pru+Frío' }
        ],
        agregados: [
            { id: 'a1', name: 'Agregado de Jamón', price: 70, description: 'Porción extra de jamón.', image: 'https://placehold.co/300x200/E91E63/FFFFFF?text=Jamón' },
            { id: 'a2', name: 'Agregado de Queso', price: 70, description: 'Porción extra de queso.', image: 'https://placehold.co/300x200/FFEB3B/000000?text=Queso' },
            { id: 'a3', name: 'Agregado de Ají Pimiento', price: 70, description: 'Porción extra de ají pimiento.', image: 'https://placehold.co/300x200/4CAF50/FFFFFF?text=Ají+Pimiento' }
        ]
    };

    // --- Selectores del DOM ---
    const napolitanasContainer = document.getElementById('napolitanas-pizzas');
    const familiaresContainer = document.getElementById('familiares-pizzas');
    const bebidasContainer = document.getElementById('bebidas-container');
    const agregadosContainer = document.getElementById('agregados-container');
    
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalElement = document.getElementById('cart-total');
    const emptyCartMessage = document.getElementById('empty-cart-message');
    const checkoutButton = document.getElementById('checkout-button'); 
    const cartModal = document.getElementById('cartModal');
    const closeCartModalButton = document.getElementById('closeCartModal');
    const cartFab = document.getElementById('cart-fab');
    const cartCountFab = document.getElementById('cart-count-fab');
    
    const orderFormSection = document.getElementById('pedido');
    const orderForm = document.getElementById('order-form'); 
    const orderSummaryElement = document.getElementById('order-summary');
    const orderTotalFormElement = document.getElementById('order-total-form');
    const orderIdFormElement = document.getElementById('order-id-form');
    const direccionInput = document.getElementById('direccion');
    const telefonoInput = document.getElementById('telefono');
    
    const adminSection = document.getElementById('admin');
    const adminLoginSection = document.getElementById('admin-login-section');
    const adminLoginForm = document.getElementById('admin-login-form');
    const adminDashboard = document.getElementById('admin-dashboard');
    const adminOrdersList = document.getElementById('admin-orders-list');

    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const navLinks = document.querySelectorAll('header nav a.nav-link, #mobile-menu a');
    const sections = document.querySelectorAll('section[id]');

    // --- Funciones Auxiliares ---
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast-message ${type === 'success' ? 'toast-success' : 'toast-error'}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        toast.offsetHeight; 
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 500); 
        }, 3000); 
    }

    function generateOrderId() {
        return `ORD-${Date.now().toString().slice(-6)}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
    }

    function formatPrice(price) {
        return `${price.toFixed(2)} CUP`; // Añadido CUP
    }
    
    function updateActiveNavLink() {
        let currentSectionId = 'hero'; 
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            if (window.scrollY >= sectionTop - 80) { 
                currentSectionId = section.id;
            }
        });
        navLinks.forEach(link => {
            link.classList.remove('active-nav');
            if (link.getAttribute('href') === `#${currentSectionId}`) {
                link.classList.add('active-nav');
            }
        });
    }

    // --- Lógica de Productos y Menú ---
    function renderProducts() {
        const renderCategory = (container, categoryProducts, productType) => {
            container.innerHTML = '';
            categoryProducts.forEach(product => {
                container.innerHTML += `
                    <div class="menu-card bg-white p-4 md:p-6 rounded-lg shadow-lg flex flex-col justify-between">
                        <div>
                            <img src="${product.image}" alt="[Imagen de ${product.name}]" class="w-full h-40 md:h-48 object-cover rounded-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/FFFFFF?text=Imagen+no+disponible';">
                            <h4 class="text-lg md:text-xl font-semibold mb-2 text-gray-800">${product.name}</h4>
                            <p class="text-gray-600 text-sm mb-3">${product.description || ''}</p>
                        </div>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-md md:text-lg font-bold text-primary">${formatPrice(product.price)}</span>
                            <button class="add-to-cart-btn bg-green-500 text-white px-3 py-2 md:px-4 md:py-2 rounded-md hover:bg-green-600 text-xs md:text-sm" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-type="${productType}">
                                Agregar <i class="fas fa-cart-plus ml-1"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        };

        renderCategory(napolitanasContainer, products.pizzasNapolitanas, 'pizza');
        renderCategory(familiaresContainer, products.pizzasFamiliares, 'pizza');
        renderCategory(bebidasContainer, products.bebidas, 'bebida');
        renderCategory(agregadosContainer, products.agregados, 'agregado');
        
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', handleAddToCart);
        });
    }

    // --- Lógica del Carrito ---
    function handleAddToCart(event) {
        const id = event.target.dataset.id;
        const name = event.target.dataset.name;
        const price = parseFloat(event.target.dataset.price);
        const type = event.target.dataset.type;

        // CORRECCIÓN: Verificar si el precio es un número válido antes de añadir al carrito.
        if (isNaN(price)) {
            console.error('Invalid price for product:', name, event.target.dataset.price);
            showToast(`Error: El producto "${name}" tiene un precio inválido.`, 'error');
            return; // Detiene la ejecución si el precio no es un número
        }

        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ id, name, price, quantity: 1, type });
        }
        renderCart();
        showToast(`${name} agregado al carrito!`, 'success');
    }

    function updateCartItemQuantity(id, change) {
        const item = cart.find(item => item.id === id);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                cart = cart.filter(cartItem => cartItem.id !== id);
            }
        }
        renderCart();
    }

    function renderCart() {
        // CORRECCIÓN: Filtrar cualquier item corrupto (con precio o cantidad inválidos) del carrito.
        const originalCount = cart.length;
        cart = cart.filter(item => !isNaN(parseFloat(item.price)) && !isNaN(parseInt(item.quantity, 10)));
        if (cart.length < originalCount) {
            console.warn('Removed corrupted items from cart.');
            showToast('Se eliminaron artículos con datos inválidos del carrito.', 'error');
        }

        cartItemsContainer.innerHTML = '';
        if (cart.length === 0) {
            emptyCartMessage.style.display = 'block';
            checkoutButton.disabled = true;
        } else {
            emptyCartMessage.style.display = 'none';
            checkoutButton.disabled = false;
            cart.forEach(item => {
                cartItemsContainer.innerHTML += `
                    <div class="flex justify-between items-center py-3 border-b">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">${formatPrice(item.price)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center">
                             <button class="quantity-change-btn text-accent-red hover:text-red-700 px-2 py-1 rounded" data-id="${item.id}" data-change="-1"><i class="fas fa-minus-circle"></i></button>
                             <span class="mx-2 text-gray-800">${item.quantity}</span>
                             <button class="quantity-change-btn text-green-500 hover:text-green-700 px-2 py-1 rounded" data-id="${item.id}" data-change="1"><i class="fas fa-plus-circle"></i></button>
                             <span class="ml-4 font-bold text-gray-800">${formatPrice(item.price * item.quantity)}</span>
                        </div>
                    </div>
                `;
            });
        }
        
        document.querySelectorAll('.quantity-change-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id; 
                const change = parseInt(e.currentTarget.dataset.change);
                updateCartItemQuantity(id, change);
            });
        });

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        // CORRECCIÓN: Asegurarse de que el total sea un número antes de mostrarlo y habilitar el botón.
        if (isNaN(total)) {
            cartTotalElement.textContent = 'Error';
            checkoutButton.disabled = true;
        } else {
            cartTotalElement.textContent = formatPrice(total);
            checkoutButton.disabled = cart.length === 0;
        }

        cartCountFab.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    }

    function openCartModal() {
        renderCart();
        cartModal.style.display = 'flex';
    }

    function closeCartModal() {
        cartModal.style.display = 'none';
    }

    // --- Lógica de Pedidos y WhatsApp ---
    function showOrderForm() {
        // CORRECCIÓN: Doble verificación para no proceder si el carrito está vacío o el total es inválido.
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        if (cart.length === 0 || isNaN(total)) {
            showToast('Tu carrito está vacío o el total es inválido.', 'error');
            return;
        }
        closeCartModal();
        hideAllSections();
        orderFormSection.classList.remove('hidden');
        window.scrollTo(0, orderFormSection.offsetTop - 80); 

        orderSummaryElement.innerHTML = cart.map(item => `
            <p>${item.name} (x${item.quantity}) - ${formatPrice(item.price * item.quantity)}</p>
        `).join('');
        
        orderTotalFormElement.textContent = formatPrice(total);
        orderIdFormElement.textContent = generateOrderId();
        direccionInput.value = '';
        telefonoInput.value = '';
    }
    
    orderForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const orderId = orderIdFormElement.textContent;
        const address = direccionInput.value.trim();
        const phone = telefonoInput.value.trim();
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        if (!address || !phone) {
            showToast('Por favor, completa la dirección y tu teléfono.', 'error');
            return;
        }

        const newOrder = {
            id: orderId,
            items: [...cart], 
            total: total,
            address: address,
            phone: phone,
            status: 'Enviado a WhatsApp', 
            timestamp: new Date().toLocaleString()
        };
        
        allOrders.push(newOrder); 
        sendOrderViaWhatsApp(newOrder);
    });

    function sendOrderViaWhatsApp(order) {
        let message = `*Nuevo Pedido de Pizzería Deliciosa*\n\n`;
        message += `*ID Pedido:* ${order.id}\n`;
        message += `*Cliente (Teléfono):* ${order.phone}\n`;
        message += `*Dirección de Entrega:* ${order.address}\n\n`;
        message += "*Items del Pedido:*\n";
        order.items.forEach(item => {
            message += `- ${item.name} (x${item.quantity}) - ${formatPrice(item.price * item.quantity)}\n`;
        });
        message += `\n*Total del Pedido:* ${formatPrice(order.total)}\n\n`;
        message += `-----------------------------------\n`;
        message += `Por favor, confirmar recepción del pedido.\n`;
        message += `Tiempo estimado de entrega: 35 minutos (aprox).`;

        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        showToast('Serás redirigido a WhatsApp para enviar tu pedido. ¡Gracias!', 'success');
        
        cart = [];
        renderCart();
        orderForm.reset();
        setTimeout(() => {
            showSection('menu'); 
        }, 1500);
        renderAdminOrders(); 
    }

    // --- Lógica del Panel de Administración (Simulado) ---
    adminLoginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('admin-password').value;
        if (password === ADMIN_PASSWORD) {
            adminLoginSection.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            renderAdminOrders();
            showToast('Acceso de administrador concedido.', 'success');
        } else {
            showToast('Contraseña de administrador incorrecta.', 'error');
        }
        adminLoginForm.reset();
    });

    function renderAdminOrders() {
        adminOrdersList.innerHTML = '';
        if (allOrders.length === 0) {
            adminOrdersList.innerHTML = '<p class="text-gray-600">No hay pedidos registrados en esta sesión.</p>';
            return;
        }
        
        let tableHtml = `
            <table class="min-w-full bg-white border border-gray-300">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">ID Pedido</th>
                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Tel. Cliente</th>
                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Dirección</th>
                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Total</th>
                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Estado (Manual)</th>
                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Fecha</th>
                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Ver Items</th>
                    </tr>
                </thead>
                <tbody>
        `;

        allOrders.slice().reverse().forEach(order => { 
            tableHtml += `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b text-sm text-gray-700">${order.id}</td>
                    <td class="py-2 px-4 border-b text-sm text-gray-700">${order.phone}</td>
                    <td class="py-2 px-4 border-b text-sm text-gray-700">${order.address}</td>
                    <td class="py-2 px-4 border-b text-sm text-gray-700">${formatPrice(order.total)}</td>
                    <td class="py-2 px-4 border-b text-sm">
                        <select data-order-id="${order.id}" class="admin-order-status-select p-1 border rounded-md text-xs ${
                            order.status === 'Entregado' ? 'bg-green-100 text-green-700' : 
                            order.status === 'Confirmado (cocina)' ? 'bg-blue-100 text-blue-700' :
                            order.status === 'Cancelado' ? 'bg-red-100 text-red-700' :
                            'bg-yellow-100 text-yellow-700'}">
                            <option value="Enviado a WhatsApp" ${order.status === 'Enviado a WhatsApp' ? 'selected' : ''}>Enviado a WhatsApp</option>
                            <option value="Confirmado (cocina)" ${order.status === 'Confirmado (cocina)' ? 'selected' : ''}>Confirmado (cocina)</option>
                            <option value="En Camino" ${order.status === 'En Camino' ? 'selected' : ''}>En Camino</option>
                            <option value="Entregado" ${order.status === 'Entregado' ? 'selected' : ''}>Entregado</option>
                            <option value="Cancelado" ${order.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </td>
                    <td class="py-2 px-4 border-b text-sm text-gray-700">${order.timestamp}</td>
                    <td class="py-2 px-4 border-b text-sm">
                        <button class="text-blue-500 hover:underline text-xs view-order-details-admin" data-order-id="${order.id}">Detalles</button>
                    </td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table>`;
        adminOrdersList.innerHTML = tableHtml;

        document.querySelectorAll('.admin-order-status-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const orderId = e.target.dataset.orderId;
                const newStatus = e.target.value;
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = newStatus;
                    showToast(`Estado del pedido ${orderId} actualizado a ${newStatus}.`, 'success');
                    e.target.className = `admin-order-status-select p-1 border rounded-md text-xs ${
                            newStatus === 'Entregado' ? 'bg-green-100 text-green-700' : 
                            newStatus === 'Confirmado (cocina)' ? 'bg-blue-100 text-blue-700' :
                            newStatus === 'Cancelado' ? 'bg-red-100 text-red-700' :
                            'bg-yellow-100 text-yellow-700'}`;
                }
            });
        });
        
        document.querySelectorAll('.view-order-details-admin').forEach(button => {
            button.addEventListener('click', (e) => {
                const orderId = e.target.dataset.orderId;
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    const itemsDetails = order.items.map(item => `${item.name} (x${item.quantity}) - ${formatPrice(item.price * item.quantity)}`).join('\n');
                    const detailMessage = `Detalles del Pedido #${order.id}:\n\nCliente (Tel): ${order.phone}\nDirección: ${order.address}\nTotal: ${formatPrice(order.total)}\nEstado Actual: ${order.status}\n\nItems:\n${itemsDetails}`;
                    alert(detailMessage); 
                }
            });
        });
    }
    
    // --- Navegación y Visibilidad de Secciones ---
    function hideAllSections() {
        orderFormSection.classList.add('hidden');
        adminSection.classList.add('hidden');
    }

    function showSection(sectionId) {
        hideAllSections(); 
        const sectionElement = document.getElementById(sectionId);
        if (sectionElement) {
            sectionElement.classList.remove('hidden');
            window.scrollTo({ top: sectionElement.offsetTop - 70, behavior: 'smooth' });
        }

        if (sectionId === 'menu' || sectionId === 'hero') {
            document.getElementById('hero').classList.remove('hidden');
            document.getElementById('menu').classList.remove('hidden');
            document.getElementById('contacto').classList.remove('hidden');
            if (sectionId === 'hero') window.scrollTo({ top: 0, behavior: 'smooth' });
        } else if (sectionId === 'contacto') {
             document.getElementById('hero').classList.remove('hidden'); 
             document.getElementById('menu').classList.remove('hidden');
             document.getElementById('contacto').classList.remove('hidden');
        } else { 
            document.getElementById('hero').classList.add('hidden');
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('contacto').classList.add('hidden');
            if (sectionElement) sectionElement.classList.remove('hidden');
        }
        updateActiveNavLink();
    }
    
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.getAttribute('href').substring(1);
            showSection(sectionId);
            if (mobileMenu.classList.contains('hidden') === false) {
                mobileMenu.classList.add('hidden');
            }
        });
    });

    // --- Inicialización ---
    document.addEventListener('DOMContentLoaded', () => {
        renderProducts();
        renderCart();
        document.getElementById('current-year').textContent = new Date().getFullYear();
        showSection('hero'); 
        cartFab.addEventListener('click', openCartModal);
        closeCartModalButton.addEventListener('click', closeCartModal);
        checkoutButton.addEventListener('click', showOrderForm); 
        window.onclick = function(event) {
            if (event.target == cartModal) {
                closeCartModal();
            }
        }
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        window.addEventListener('scroll', updateActiveNavLink);
        updateActiveNavLink(); 
        loadDataFromLocalStorage();
        renderAdminOrders(); 
    });

    // --- Simulación de persistencia con localStorage ---
    function saveDataToLocalStorage() {
        localStorage.setItem('pizzeriaCart', JSON.stringify(cart));
        localStorage.setItem('pizzeriaAllOrders', JSON.stringify(allOrders));
    }

    function loadDataFromLocalStorage() {
        const storedCart = localStorage.getItem('pizzeriaCart');
        if (storedCart) cart = JSON.parse(storedCart);
        const storedOrders = localStorage.getItem('pizzeriaAllOrders');
        if (storedOrders) allOrders = JSON.parse(storedOrders);
        renderCart();
    }
    window.addEventListener('beforeunload', saveDataToLocalStorage);
</script>
</body>
</html>
